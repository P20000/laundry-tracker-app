# Render Blueprint for the Smart Wardrobe App Monorepo (Final attempt at fixing build context)

services:

# -------------------------------------------------
# 1. Managed Database (MySQL) - Unchanged
# -------------------------------------------------
- type: pserv
  name: smart-wardrobe-db
  plan: free
  disk:
    name: mysqldata
    sizeGB: 1
  env: mysql

# -------------------------------------------------
# 2. Backend API (Node.js/Express) - REQUIRES ABSOLUTE PATHS TO FILES
# -------------------------------------------------
- type: web
  name: api
  rootDir: backend 
  env: node
  plan: free 
  
  # CRITICAL FIX: Run commands inside the backend folder where package.json lives
  # This fixes the initial 'npm install' failure.
  buildCommand: "npm install --prefix backend && npm run build:ts --prefix backend"
  
  # CRITICAL FIX: The start command must be aware of the new location of 'dist/' and 'prisma'
  startCommand: "npx prisma migrate deploy --schema=backend/prisma/schema.prisma && node backend/dist/index.js"
  
  healthCheckPath: "/health"
  
  envVars:
    - key: DATABASE_URL
      fromDatabase:
        name: smart-wardrobe-db
        property: connectionString
    - key: NODE_ENV
      value: production
  
  autoDeploy: true
  port: 3000

# -------------------------------------------------
# 3. Frontend (React/Nginx) - Docker is better for static assets/Nginx
# -------------------------------------------------
- type: web
  name: frontend
  # Render automatically detects the Dockerfile in the rootDir.
  rootDir: frontend
  env: docker # CRITICAL: Force using the Dockerfile
  plan: free
  
  envVars:
    - key: VITE_APP_API_URL
      value: "https://${{RENDER_EXTERNAL_HOSTNAME}}/api"
      
  autoDeploy: true
  port: 80